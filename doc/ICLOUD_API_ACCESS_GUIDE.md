# Accessing iCloud Content in Your App - Complete Guide

## ‚ö†Ô∏è Important: iCloud is Different from Google/Microsoft

Unlike Google (Drive, Gmail, Calendar) and Microsoft (OneDrive, Outlook Mail, Calendar), **iCloud does NOT provide standard OAuth REST APIs** for accessing user content. Instead, iCloud uses different protocols for different services.

## Overview: How to Access iCloud Services

| Service | Method | Authentication | Difficulty |
|---------|--------|----------------|------------|
| **iCloud Mail** | IMAP/SMTP | App-specific password | Medium |
| **iCloud Calendar** | CalDAV | App-specific password | Medium |
| **iCloud Contacts** | CardDAV | App-specific password | Medium |
| **iCloud Drive** | CloudKit API | CloudKit tokens | Hard |
| **iCloud Notes** | CloudKit API | CloudKit tokens | Hard |
| **iCloud Photos** | Not available | N/A | N/A |

## Option 1: iCloud Mail (IMAP/SMTP) üìß

### Overview
Access iCloud Mail using standard IMAP/SMTP protocols with app-specific passwords.

### How It Works
1. User generates an **app-specific password** from their Apple ID settings
2. Your app uses this password to connect via IMAP/SMTP
3. You can read/send emails programmatically

### Server Settings
```
IMAP Server: imap.mail.me.com
IMAP Port: 993 (SSL required)
SMTP Server: smtp.mail.me.com
SMTP Port: 587 (TLS)
Username: user@icloud.com (full iCloud email)
Password: app-specific-password (generated by user)
```

### Implementation Steps

#### Step 1: Create Email Service Module

Create `backend/shared/services/icloud-mail.ts`:

```typescript
import Imap from 'imap';
import { simpleParser } from 'mailparser';

export interface ICloudMailConfig {
  email: string;
  appSpecificPassword: string; // User provides this
}

export class ICloudMailService {
  private config: ICloudMailConfig;
  
  constructor(config: ICloudMailConfig) {
    this.config = config;
  }

  /**
   * Connect to iCloud Mail via IMAP
   */
  private createImapConnection(): Imap {
    return new Imap({
      user: this.config.email,
      password: this.config.appSpecificPassword,
      host: 'imap.mail.me.com',
      port: 993,
      tls: true,
      tlsOptions: { rejectUnauthorized: false },
    });
  }

  /**
   * Get unread emails
   */
  async getUnreadEmails(limit: number = 10): Promise<any[]> {
    return new Promise((resolve, reject) => {
      const imap = this.createImapConnection();
      const emails: any[] = [];

      imap.once('ready', () => {
        imap.openBox('INBOX', false, (err, box) => {
          if (err) {
            imap.end();
            return reject(err);
          }

          // Search for unread emails
          imap.search(['UNSEEN'], (err, results) => {
            if (err) {
              imap.end();
              return reject(err);
            }

            if (results.length === 0) {
              imap.end();
              return resolve([]);
            }

            // Fetch emails (limit to last N)
            const fetch = imap.fetch(results.slice(-limit), {
              bodies: '',
              struct: true,
            });

            fetch.on('message', (msg, seqno) => {
              msg.on('body', (stream, info) => {
                simpleParser(stream, (err, parsed) => {
                  if (!err) {
                    emails.push({
                      subject: parsed.subject,
                      from: parsed.from?.text,
                      date: parsed.date,
                      text: parsed.text,
                      html: parsed.html,
                    });
                  }
                });
              });
            });

            fetch.once('end', () => {
              imap.end();
              resolve(emails);
            });
          });
        });
      });

      imap.once('error', reject);
      imap.connect();
    });
  }

  /**
   * Send email via SMTP
   */
  async sendEmail(to: string, subject: string, body: string): Promise<void> {
    // Use nodemailer or similar for SMTP
    // Implementation depends on your SMTP library choice
    throw new Error('SMTP sending not yet implemented');
  }
}
```

#### Step 2: Store App-Specific Passwords in Database

You'll need to store the user's app-specific password. **Important**: Encrypt this!

Add to your database schema:

```sql
-- Add app-specific password storage (encrypted)
ALTER TABLE user_oauth_tokens 
ADD COLUMN IF NOT EXISTS app_specific_password TEXT; -- Store encrypted password for iCloud

-- Or create separate table for iCloud credentials
CREATE TABLE IF NOT EXISTS user_icloud_credentials (
  credential_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  email VARCHAR(255) NOT NULL,
  app_specific_password_encrypted TEXT NOT NULL, -- Encrypted!
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE(user_id)
);
```

#### Step 3: Create API Endpoint

Create `backend/services/api-gateway/src/routes/icloud.ts`:

```typescript
import { Router } from 'express';
import { authenticate } from '../../shared/auth/middleware';
import { ICloudMailService } from '../../shared/services/icloud-mail';

const router = Router();

// Get user's iCloud mail credentials
router.get('/mail/credentials', authenticate, async (req, res, next) => {
  try {
    // Check if user has iCloud credentials stored
    // Return status (connected/not connected)
    res.json({ connected: false, message: 'Not implemented yet' });
  } catch (error) {
    next(error);
  }
});

// Store iCloud mail credentials (email + app-specific password)
router.post('/mail/connect', authenticate, async (req, res, next) => {
  try {
    const { email, appSpecificPassword } = req.body;
    
    // TODO: Encrypt password before storing
    // TODO: Store in database
    // TODO: Verify credentials work
    
    res.json({ success: true, message: 'iCloud Mail connected' });
  } catch (error) {
    next(error);
  }
});

// Get unread emails
router.get('/mail/unread', authenticate, async (req, res, next) => {
  try {
    // TODO: Get user's encrypted credentials
    // TODO: Decrypt app-specific password
    // TODO: Use ICloudMailService to fetch emails
    
    res.json({ emails: [] });
  } catch (error) {
    next(error);
  }
});

export default router;
```

### User Flow

1. User goes to Settings ‚Üí Connected Accounts
2. User clicks "Connect iCloud Mail"
3. User enters their iCloud email
4. App shows instructions: "Generate an app-specific password at appleid.apple.com"
5. User generates password and enters it
6. App stores encrypted password
7. App can now access iCloud Mail via IMAP

### Required Libraries

```bash
npm install imap mailparser nodemailer
npm install --save-dev @types/imap @types/nodemailer
```

### Limitations

- ‚ö†Ô∏è User must manually generate app-specific password
- ‚ö†Ô∏è Cannot use standard OAuth flow
- ‚ö†Ô∏è Password must be stored securely (encrypted)
- ‚ö†Ô∏è User must trust your app with their password

---

## Option 2: iCloud Calendar (CalDAV) üìÖ

### Overview
Access iCloud Calendar using CalDAV protocol with app-specific passwords.

### How It Works
1. User provides app-specific password
2. Your app connects to CalDAV server
3. You can read/create/update calendar events

### Server Settings
```
CalDAV Server: https://caldav.icloud.com
Username: user@icloud.com
Password: app-specific-password
```

### Implementation

Create `backend/shared/services/icloud-calendar.ts`:

```typescript
import { CalDAVClient } from 'tsdav';

export class ICloudCalendarService {
  private client: CalDAVClient;
  
  constructor(email: string, appSpecificPassword: string) {
    this.client = new CalDAVClient({
      serverUrl: 'https://caldav.icloud.com',
      credentials: {
        username: email,
        password: appSpecificPassword,
      },
    });
  }

  /**
   * Get calendar events for date range
   */
  async getEvents(startDate: Date, endDate: Date): Promise<any[]> {
    await this.client.login();
    
    const calendars = await this.client.fetchCalendars();
    const events = [];

    for (const calendar of calendars) {
      const calendarEvents = await this.client.fetchCalendarObjects({
        calendar: calendar,
        timeRange: {
          start: startDate.toISOString(),
          end: endDate.toISOString(),
        },
      });
      
      events.push(...calendarEvents);
    }

    return events;
  }

  /**
   * Create calendar event
   */
  async createEvent(summary: string, start: Date, end: Date): Promise<void> {
    // Implementation using CalDAV
    throw new Error('Not yet implemented');
  }
}
```

### Required Libraries

```bash
npm install tsdav
```

---

## Option 3: iCloud Drive (CloudKit) üìÅ

### Overview
Access iCloud Drive using CloudKit API. This is the most complex option and requires:
- Apple Developer account
- CloudKit container setup
- Native app or web app with CloudKit JS

### How It Works
1. User signs in with Apple ID
2. CloudKit generates tokens
3. Your app uses CloudKit API to access files

### Limitations
- ‚ö†Ô∏è Requires native iOS/macOS app OR CloudKit JS (web)
- ‚ö†Ô∏è Cannot be done from server-side Node.js easily
- ‚ö†Ô∏è Most complex option

### Recommendation
For web applications, iCloud Drive access is **very limited**. Consider:
- Asking users to share files via Google Drive/OneDrive instead
- Using file upload instead of iCloud Drive integration

---

## Comparison: Google vs Microsoft vs iCloud

| Feature | Google | Microsoft | iCloud |
|---------|--------|-----------|--------|
| **OAuth REST API** | ‚úÖ Yes | ‚úÖ Yes | ‚ùå No |
| **Mail Access** | ‚úÖ Gmail API | ‚úÖ Outlook API | ‚ö†Ô∏è IMAP only |
| **Calendar Access** | ‚úÖ Calendar API | ‚úÖ Calendar API | ‚ö†Ô∏è CalDAV only |
| **Drive Access** | ‚úÖ Drive API | ‚úÖ OneDrive API | ‚ö†Ô∏è CloudKit only |
| **Ease of Setup** | ‚≠ê‚≠ê‚≠ê Easy | ‚≠ê‚≠ê‚≠ê Easy | ‚≠ê Hard |

---

## Recommended Approach for Your App

### Phase 1: Start with Google & Microsoft (Easier)
1. ‚úÖ **Google OAuth** - Already implemented
   - Gmail API for mail
   - Calendar API for calendar
   - Drive API for files

2. ‚úÖ **Microsoft OAuth** - Already implemented
   - Outlook Mail API
   - Calendar API
   - OneDrive API

### Phase 2: Add iCloud Mail & Calendar (If Needed)
1. **iCloud Mail via IMAP**
   - User provides app-specific password
   - Use IMAP library to access mail
   - Store password encrypted

2. **iCloud Calendar via CalDAV**
   - Use CalDAV library
   - Same app-specific password

### Phase 3: Skip iCloud Drive (Too Complex)
- Focus on Google Drive/OneDrive instead
- Or use file upload

---

## Implementation Checklist

### For iCloud Mail (IMAP)

- [ ] Install IMAP library (`imap`, `mailparser`)
- [ ] Create database table for encrypted passwords
- [ ] Create `ICloudMailService` class
- [ ] Create API endpoints:
  - [ ] `POST /icloud/mail/connect` - Store credentials
  - [ ] `GET /icloud/mail/unread` - Get unread emails
  - [ ] `GET /icloud/mail/list` - List emails
- [ ] Add encryption for app-specific passwords
- [ ] Create frontend UI for connecting iCloud Mail
- [ ] Add instructions for generating app-specific passwords

### For iCloud Calendar (CalDAV)

- [ ] Install CalDAV library (`tsdav`)
- [ ] Create `ICloudCalendarService` class
- [ ] Create API endpoints:
  - [ ] `POST /icloud/calendar/connect` - Store credentials
  - [ ] `GET /icloud/calendar/events` - Get events
  - [ ] `POST /icloud/calendar/events` - Create event
- [ ] Create frontend UI for connecting iCloud Calendar

---

## Security Considerations

1. **Encrypt App-Specific Passwords**
   - Never store plain text passwords
   - Use encryption (AES-256)
   - Store encryption key securely

2. **User Consent**
   - Clearly explain what you'll access
   - Show what permissions are needed
   - Allow users to disconnect

3. **Password Handling**
   - Don't log passwords
   - Don't expose in API responses
   - Allow users to regenerate passwords

---

## Next Steps

1. **Decide which services you need**:
   - Do you need iCloud Mail? ‚Üí Use IMAP
   - Do you need iCloud Calendar? ‚Üí Use CalDAV
   - Do you need iCloud Drive? ‚Üí Consider alternatives

2. **Start with Google/Microsoft first** (easier):
   - Already have OAuth working
   - Standard REST APIs
   - Better documentation

3. **Add iCloud later if needed**:
   - More complex setup
   - Requires user to generate app-specific passwords
   - Less user-friendly than OAuth

---

## Resources

- [Apple Support: App-Specific Passwords](https://support.apple.com/en-us/102654)
- [iCloud Mail IMAP Settings](https://support.apple.com/en-us/102654)
- [CalDAV Protocol](https://tools.ietf.org/html/rfc4791)
- [CloudKit Documentation](https://developer.apple.com/documentation/cloudkit)

---

## Quick Start: iCloud Mail

1. User generates app-specific password at appleid.apple.com
2. User enters email + password in your app
3. Your app stores encrypted password
4. Your app connects via IMAP to `imap.mail.me.com`
5. Your app can now read/send emails

That's it! No OAuth needed, but less secure/user-friendly than OAuth.
